<% content_for :title, "History" %>

<%= render 'nav' %>

<% in_edition_number = @document.current_edition_number %>

<% unless @document.publication_state == "published-to-live" %>
<h2 class='govuk-heading-l'><%= in_edition_number.ordinalize %> edition (unpublished)</h2>
<% end %>

<% @document.versions.reverse.each do |version| %>
  <% if version.reify && version.reify.current_edition_number != in_edition_number %>
    <% in_edition_number = version.reify.current_edition_number %>
    <h2 class='govuk-heading-l'><%= in_edition_number.ordinalize %> edition</h2>
  <% end %>

  <h3 class='govuk-heading-m'>Document <%= version.event %></h3>

  <div>
  <% version.changeset.each do |attribute, (from, to)| %>
    <p>
      <% if attribute == "publication_state" && to == "published-to-live" %>
        <%= in_edition_number.ordinalize %> edition published to GOV.UK.
      <% end %>

      <% next if attribute.in?(%w[updated_at created_at id content_id locale publication_state current_edition_number]) %>

      <% if from.blank? %>
        <%= attribute.humanize %> added: <%= to.inspect %>
      <% elsif to.blank? %>
        <%= attribute.humanize %> removed
      <% else %>
        <%= attribute.humanize %> changed from <strike><%= (from || "").inspect %></strike>
        to <%= to.inspect %>
      <% end %>
    </p>
  <% end %>
  </div>

  <% if version.next %>
  <details class='govuk-details'>
    <summary class='govuk-details__summary'>This version</summary>
    <pre>
      <%= version.next.object %>
    </pre>
    <%= button_to "roll back to this version", roll_back_to_version_path(version) %>
  </details>
  <% end %>
<% end %>
